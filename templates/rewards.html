{% extends "base.html" %}

{% block content %}
<div class="mb-8 pt-4">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold mb-2 text-white uppercase tracking-widest glitch-text"
                data-text="Black Market">
                Black Market
            </h1>
            <p class="text-cyber-gold text-sm tracking-wider uppercase">Exchange Credits for Gear</p>
        </div>
        {% if user %}
        <div
            class="bg-cyber-dark border border-cyber-gold/30 rounded-xl px-4 py-2 flex flex-col items-end shadow-neon-gold">
            <div class="text-[10px] text-gray-400 uppercase tracking-widest">Balance</div>
            <div class="text-2xl font-bold text-cyber-gold" id="userPoints">{{ user.points }} <span
                    class="text-xs">CR</span></div>
        </div>
        {% endif %}
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for reward in rewards %}
    <div
        class="group relative bg-cyber-dark/80 backdrop-blur-md border border-white/5 rounded-xl overflow-hidden shadow-lg hover:shadow-neon-red transition-all duration-300 hover:-translate-y-1 cursor-pointer"
        data-reward-id="{{ reward.id }}"
        data-reward-title="{{ reward.title|e }}"
        data-reward-cost="{{ reward.cost }}"
        data-reward-desc="{{ (reward.description or '')|e }}"
        data-reward-image="{{ reward.image_url or '' }}"
        data-reward-stock="{{ reward.stock if reward.stock is not none else '' }}"
        data-reward-category="{{ reward.category or '' }}"
        onclick="openRewardDetails(this)">
        <!-- Reward Image -->
        <div class="h-48 bg-cyber-black relative overflow-hidden group-hover:opacity-90 transition-opacity">
            <div class="absolute inset-0 bg-gradient-to-t from-cyber-dark to-transparent z-10"></div>
            {% if reward.image_url %}
            <img src="{{ reward.image_url }}" alt="{{ reward.title }}" class="w-full h-full object-cover">
            {% else %}
            <div class="w-full h-full flex items-center justify-center">
                <i class="fas fa-cube text-6xl text-gray-700 group-hover:text-cyber-red transition-colors"></i>
            </div>
            {% endif %}

            <!-- Category Badge -->
            {% if reward.category %}
            <div class="absolute top-3 right-3 z-20">
                <span
                    class="px-2 py-1 rounded bg-cyber-black/80 border border-cyber-red/50 text-cyber-red text-[10px] font-bold uppercase tracking-wider backdrop-blur-sm">
                    {{ reward.category }}
                </span>
            </div>
            {% endif %}
        </div>

        <!-- Reward Info -->
        <div class="p-5 relative z-20">
            <h3
                class="font-bold text-lg text-white mb-2 group-hover:text-cyber-red transition-colors uppercase tracking-wide">
                {{ reward.title }}
            </h3>

            <p class="text-sm text-gray-400 mb-4 line-clamp-2">{{ reward.description or 'No description available' }}
            </p>

            <!-- Stock Info -->
            <div class="flex items-center justify-between mb-4 text-xs font-mono">
                {% if reward.stock is not none %}
                {% if reward.stock > 0 %}
                <span class="text-green-400"><i class="fas fa-box mr-1"></i> {{ reward.stock }} IN STOCK</span>
                {% else %}
                <span class="text-red-500"><i class="fas fa-times mr-1"></i> SOLD OUT</span>
                {% endif %}
                {% else %}
                <span class="text-cyber-gold"><i class="fas fa-infinity mr-1"></i> UNLIMITED</span>
                {% endif %}
            </div>


        </div>
    </div>
    {% endfor %}

    {% if not rewards %}
    <div class="col-span-full text-center py-16 border border-dashed border-white/10 rounded-xl">
        <i class="fas fa-box-open text-4xl text-gray-600 mb-4"></i>
        <p class="text-gray-400 text-xl mb-2">Black Market Empty</p>
        <p class="text-gray-600 text-sm">Check back later for new shipments.</p>
    </div>
    {% endif %}
</div>

<!-- Reward Details Modal -->
<div id="rewardDetailsModal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-cyber-black border border-white/10 rounded-xl p-6 max-w-3xl w-full mx-4 shadow-2xl relative overflow-hidden">
        <button onclick="closeRewardDetails()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
            <i class="fas fa-times fa-lg"></i>
        </button>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="col-span-1 bg-gray-900 rounded overflow-hidden h-56 md:h-full">
                <img id="detailImage" src="" alt="" class="w-full h-full object-cover">
            </div>
            <div class="col-span-2">
                <h2 id="detailTitle" class="text-2xl font-bold text-white mb-2"></h2>
                <p id="detailCategory" class="text-sm text-purple-300 mb-3"></p>
                <p id="detailDescription" class="text-gray-300 mb-4"></p>
                <div class="flex items-center gap-4 mb-4">
                    <div class="text-cyber-gold font-bold text-xl" id="detailCost"></div>
                    <div class="text-sm text-gray-400" id="detailStock"></div>
                </div>

                <div class="flex gap-3">
                    <button id="detailClaimBtn" onclick="claimFromDetails()"
                        class="bg-cyber-red hover:bg-red-600 text-white px-6 py-3 rounded-lg font-bold uppercase tracking-wider">
                        Claim
                    </button>
                    <button onclick="closeRewardDetails()" class="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-lg font-bold">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Claim Confirmation Modal -->
<div id="claimModal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div
        class="bg-cyber-black border border-cyber-red/30 rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl shadow-cyber-red/20 relative overflow-hidden">
        <!-- Decorative line -->
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyber-red to-transparent"></div>

        <h2 class="text-xl font-bold text-white mb-4 uppercase tracking-wider flex items-center gap-2">
            <i class="fas fa-exclamation-triangle text-cyber-red"></i> Confirm Transaction
        </h2>
        <p class="text-gray-300 mb-6" id="claimMessage"></p>
        <div class="flex gap-3">
            <button onclick="confirmClaim()"
                class="flex-1 bg-cyber-red hover:bg-red-600 text-white px-6 py-3 rounded-lg font-bold uppercase tracking-wider transition-all shadow-lg hover:shadow-neon-red">
                Confirm
            </button>
            <button onclick="closeClaimModal()"
                class="flex-1 bg-transparent border border-white/20 hover:bg-white/5 text-white px-6 py-3 rounded-lg font-bold uppercase tracking-wider transition-colors">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
    let selectedRewardId = null;
    let detailRewardId = null;

    function openRewardDetails(el) {
        const id = el.dataset.rewardId;
        const title = el.dataset.rewardTitle || '';
        const cost = el.dataset.rewardCost || 0;
        const desc = el.dataset.rewardDesc || '';
        const img = el.dataset.rewardImage || '';
        const stock = el.dataset.rewardStock || '';
        const category = el.dataset.rewardCategory || '';

        detailRewardId = id;

        const imgEl = document.getElementById('detailImage');
        if (img) {
            imgEl.src = img;
            imgEl.alt = title;
            imgEl.parentElement.style.display = '';
        } else {
            imgEl.src = '';
            imgEl.alt = '';
            imgEl.parentElement.style.display = 'none';
        }

        document.getElementById('detailTitle').textContent = title;
        document.getElementById('detailDescription').textContent = desc || 'No description provided.';
        document.getElementById('detailCategory').textContent = category ? `Category: ${category}` : '';
        document.getElementById('detailCost').textContent = `${cost} CR`;
        document.getElementById('detailStock').textContent = stock ? (stock > 0 ? `${stock} in stock` : 'Sold out') : 'Unlimited';

        document.getElementById('rewardDetailsModal').classList.remove('hidden');
    }

    function closeRewardDetails() {
        document.getElementById('rewardDetailsModal').classList.add('hidden');
        detailRewardId = null;
    }

    function claimFromDetails() {
        if (!detailRewardId) return;
        // read title and cost from modal
        const title = document.getElementById('detailTitle').textContent || '';
        const costText = document.getElementById('detailCost').textContent || '0';
        const cost = parseInt(costText, 10) || 0;

        // close details and open claim modal
        closeRewardDetails();
        claimReward(detailRewardId, title, cost);
    }

    function claimReward(rewardId, title, cost) {
        selectedRewardId = rewardId;
        const userPoints = parseInt(document.getElementById('userPoints').textContent);

        if (userPoints < cost) {
            showModal('Insufficient Funds', `You need ${cost} Credits but only have ${userPoints}.`);
            return;
        }

        document.getElementById('claimMessage').textContent =
            `Purchase "${title}" for ${cost} Credits?`;
        document.getElementById('claimModal').classList.remove('hidden');
    }

    function closeClaimModal() {
        document.getElementById('claimModal').classList.add('hidden');
        selectedRewardId = null;
    }

    function confirmClaim() {
        if (!selectedRewardId) return;

        const btn = event.currentTarget;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Processing...';

        fetch(`/rewards/claim/${selectedRewardId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showModal('Transaction Complete', `âœ… Acquired: ${data.reward_title}\nðŸ’° Cost: ${data.points_spent} CR\nðŸ’µ Balance: ${data.remaining_points} CR`, () => {
                        location.reload();
                    });
                } else {
                    showModal('Transaction Failed', data.error || 'Failed to claim reward');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
                closeClaimModal();
            })
            .catch(error => {
                console.error('Error:', error);
                showModal('Error', 'System Error');
                btn.disabled = false;
                btn.textContent = originalText;
                closeClaimModal();
            });
    }
</script>
{% endblock %}