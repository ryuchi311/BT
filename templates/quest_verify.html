{% extends "base.html" %}

{% block content %}
<div data-quest-id="{{ quest.id }}" data-video-url="{{ quest.action_url }}" id="questData" style="display: none;"></div>
<div class="w-full" style="min-height: calc(100vh - 6rem); padding-top: 1rem; padding-bottom: 1rem;">
    <div class="max-w-2xl w-full mx-auto">
        <!-- Quest Header Card -->
        <div
            class="bg-cyber-dark/80 backdrop-blur-md rounded-2xl border border-cyber-gold/30 shadow-neon-gold p-6 mb-4 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyber-gold to-cyber-red"></div>

            <div class="text-center relative z-10">
                <div
                    class="w-20 h-20 mx-auto bg-cyber-black rounded-full flex items-center justify-center mb-4 border border-white/10 shadow-lg">
                    <i class="fab fa-youtube text-4xl text-red-500"></i>
                </div>
                <h1 class="text-3xl font-bold text-white uppercase tracking-widest glitch-text mb-2"
                    data-text="{{ quest.title }}">
                    {{ quest.title }}
                </h1>
                <p class="text-gray-400 mb-4 font-mono text-sm">{{ quest.description }}</p>
                <div
                    class="inline-flex items-center gap-2 bg-cyber-gold/10 border border-cyber-gold/50 rounded-lg px-4 py-2">
                    <i class="fas fa-coins text-cyber-gold"></i>
                    <span class="text-cyber-gold font-bold uppercase tracking-wider">{{ quest.points }} Credits</span>
                </div>
            </div>
        </div>

        <!-- Verification Steps Card -->
        <div class="bg-cyber-dark/80 backdrop-blur-md rounded-2xl border border-white/5 shadow-2xl p-6 relative">

            <!-- Step 1: Start Watch Button -->
            <div id="startSection" class="text-center">
                <h2 class="text-2xl font-bold text-white mb-4 uppercase tracking-wider">Mission Briefing</h2>
                <p class="text-gray-400 mb-6 font-mono text-sm">Initiate video playback to start the synchronization
                    timer.</p>
                <button id="startWatchBtn"
                    class="bg-cyber-red hover:bg-red-600 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-neon-red uppercase tracking-widest clip-path-polygon">
                    <i class="fab fa-youtube mr-2"></i>
                    Start Mission
                </button>
            </div>

            <!-- Step 2: Countdown Timer -->
            <div id="countdownSection" class="hidden text-center">
                <h2 class="text-2xl font-bold text-white mb-4 uppercase tracking-wider">Syncing...</h2>
                <p class="text-gray-400 mb-6 font-mono text-sm">Watch the transmission. Code input unlocks upon
                    completion.</p>

                <!-- Circular Progress Timer -->
                <div class="relative w-64 h-64 mx-auto mb-6">
                    <svg class="transform -rotate-90 w-64 h-64">
                        <circle cx="128" cy="128" r="120" stroke="rgba(255,255,255,0.05)" stroke-width="4"
                            fill="none" />
                        <circle id="progressCircle" cx="128" cy="128" r="120" stroke="#FEBD11" stroke-width="4"
                            fill="none" stroke-dasharray="753.98" stroke-dashoffset="0"
                            class="transition-all duration-1000 shadow-[0_0_10px_#FEBD11]" stroke-linecap="round" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="timerDisplay" class="text-6xl font-bold text-white mb-2 font-mono">02:00</span>
                        <span class="text-cyber-gold text-xs uppercase tracking-widest animate-pulse">Remaining</span>
                    </div>
                </div>

                <div class="bg-cyber-black/50 border border-cyber-gold/20 rounded-lg p-4">
                    <p class="text-cyber-gold text-xs font-mono uppercase">
                        <i class="fas fa-lock mr-2"></i>
                        Security Protocol Active
                    </p>
                </div>
            </div>

            <!-- Step 3: Code Input -->
            <div id="codeSection" class="hidden text-center">
                <h2 class="text-2xl font-bold text-white mb-4 uppercase tracking-wider">Verification Required</h2>
                <p class="text-gray-400 mb-6 font-mono text-sm">Enter the access code from the transmission.</p>

                <div class="max-w-md mx-auto">
                    <input type="text" id="codeInput" placeholder="ENTER CODE"
                        class="w-full bg-cyber-black border border-cyber-gold/50 rounded-lg px-6 py-4 text-cyber-gold text-center text-2xl font-bold placeholder-gray-700 focus:outline-none focus:border-cyber-gold focus:shadow-neon-gold transition-all mb-4 uppercase tracking-widest font-mono"
                        maxlength="20">

                    <div id="errorMessage" class="hidden bg-red-500/10 border border-red-500/50 rounded-lg p-3 mb-4">
                        <p class="text-red-400 text-xs font-mono uppercase">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <span id="errorText"></span>
                        </p>
                    </div>

                    <button id="submitCodeBtn"
                        class="w-full bg-cyber-gold hover:bg-yellow-400 text-cyber-black font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-neon-gold uppercase tracking-widest clip-path-polygon">
                        <i class="fas fa-check mr-2"></i>
                        Verify Access
                    </button>
                </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="text-center mt-4">
            <a href="{{ url_for('quests.list_quests') }}"
                class="text-gray-500 hover:text-cyber-gold transition-colors text-sm uppercase tracking-wider">
                <i class="fas fa-arrow-left mr-2"></i>
                Abort Mission
            </a>
        </div>
    </div>
</div>

<!-- Congratulations Modal -->
<div id="congratsModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="congrats-title" role="dialog"
    aria-modal="true">
    <div class="fixed inset-0 bg-cyber-black/90 backdrop-blur-md transition-opacity"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                class="relative transform overflow-hidden rounded-2xl bg-cyber-dark border border-cyber-gold text-center shadow-2xl shadow-cyber-gold/20 transition-all w-full max-w-md p-8">
                <!-- Confetti Animation -->
                <div class="confetti-container absolute inset-0 pointer-events-none overflow-hidden opacity-50">
                    <div class="confetti bg-cyber-gold"></div>
                    <div class="confetti bg-cyber-red"></div>
                    <div class="confetti bg-white"></div>
                </div>

                <!-- Success Icon -->
                <div
                    class="w-24 h-24 mx-auto bg-cyber-black border-2 border-cyber-gold rounded-full flex items-center justify-center mb-6 shadow-neon-gold animate-bounce">
                    <i class="fas fa-trophy text-5xl text-cyber-gold"></i>
                </div>

                <h2 id="congrats-title" class="text-3xl font-bold text-white mb-2 uppercase tracking-widest glitch-text"
                    data-text="Mission Complete">
                    Mission Complete
                </h2>

                <p class="text-gray-400 mb-6 font-mono text-sm">Reward transferred to your account.</p>

                <div class="bg-cyber-gold/10 border border-cyber-gold/30 rounded-lg p-6 mb-6">
                    <p class="text-cyber-gold text-xs uppercase tracking-wider mb-2">Credits Acquired</p>
                    <p id="pointsEarned" class="text-5xl font-bold text-white text-shadow-gold">+0</p>
                </div>

                <div class="bg-white/5 rounded-lg p-4 mb-6 flex justify-between items-center">
                    <p class="text-gray-400 text-xs uppercase tracking-wider">Total Balance</p>
                    <p id="totalPoints" class="text-xl font-bold text-cyber-gold">0</p>
                </div>

                <button id="continueBtn"
                    class="w-full bg-cyber-gold hover:bg-yellow-400 text-cyber-black font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-neon-gold uppercase tracking-widest clip-path-polygon">
                    <i class="fas fa-forward mr-2"></i>
                    Continue
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .clip-path-polygon {
        clip-path: polygon(5% 0, 100% 0, 100% 80%, 95% 100%, 0 100%, 0 20%);
    }

    .text-shadow-gold {
        text-shadow: 0 0 10px rgba(254, 189, 17, 0.5);
    }

    /* Confetti Animation */
    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #FEBD11;
        animation: confetti-fall 3s linear infinite;
    }

    .confetti:nth-child(1) {
        left: 10%;
        animation-delay: 0s;
        background: #FEBD11;
    }

    .confetti:nth-child(2) {
        left: 20%;
        animation-delay: 0.2s;
        background: #f31e21;
    }

    .confetti:nth-child(3) {
        left: 30%;
        animation-delay: 0.4s;
        background: #ffffff;
    }

    .confetti:nth-child(4) {
        left: 40%;
        animation-delay: 0.6s;
        background: #FEBD11;
    }

    .confetti:nth-child(5) {
        left: 50%;
        animation-delay: 0.8s;
        background: #f31e21;
    }

    .confetti:nth-child(6) {
        left: 60%;
        animation-delay: 1s;
        background: #ffffff;
    }

    .confetti:nth-child(7) {
        left: 70%;
        animation-delay: 1.2s;
        background: #FEBD11;
    }

    .confetti:nth-child(8) {
        left: 80%;
        animation-delay: 1.4s;
        background: #f31e21;
    }

    .confetti:nth-child(9) {
        left: 90%;
        animation-delay: 1.6s;
        background: #ffffff;
    }

    @keyframes confetti-fall {
        0% {
            top: -10%;
            transform: translateX(0) rotateZ(0deg);
        }

        100% {
            top: 110%;
            transform: translateX(100px) rotateZ(360deg);
        }
    }
</style>

<script>
    const questData = document.getElementById('questData');
    const questId = parseInt(questData.dataset.questId);
    const videoUrl = questData.dataset.videoUrl;
    const totalSeconds = 120; // 2 minutes
    let timeLeft = totalSeconds;
    let timerInterval = null;

    const startSection = document.getElementById('startSection');
    const countdownSection = document.getElementById('countdownSection');
    const codeSection = document.getElementById('codeSection');
    const startWatchBtn = document.getElementById('startWatchBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const progressCircle = document.getElementById('progressCircle');
    const codeInput = document.getElementById('codeInput');
    const submitCodeBtn = document.getElementById('submitCodeBtn');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const congratsModal = document.getElementById('congratsModal');
    const pointsEarned = document.getElementById('pointsEarned');
    const totalPoints = document.getElementById('totalPoints');
    const continueBtn = document.getElementById('continueBtn');

    const circumference = 2 * Math.PI * 120; // 2Ï€r

    // Start Watch Button
    startWatchBtn.addEventListener('click', () => {
        window.open(videoUrl, '_blank');
        startSection.classList.add('hidden');
        countdownSection.classList.remove('hidden');
        startCountdown();
    });

    function startCountdown() {
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimer();

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showCodeInput();
            }
        }, 1000);
    }

    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        const progress = (timeLeft / totalSeconds) * circumference;
        progressCircle.style.strokeDashoffset = circumference - progress;

        if (timeLeft <= 10) {
            timerDisplay.classList.add('text-cyber-red', 'animate-pulse');
        }
    }

    function showCodeInput() {
        countdownSection.classList.add('hidden');
        codeSection.classList.remove('hidden');
        codeInput.focus();
    }

    submitCodeBtn.addEventListener('click', submitCode);
    codeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            submitCode();
        }
    });

    async function submitCode() {
        const code = codeInput.value.trim();

        if (!code) {
            showError('ACCESS CODE REQUIRED');
            return;
        }

        submitCodeBtn.disabled = true;
        submitCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>VERIFYING...';

        try {
            const response = await fetch(`/quests/verify-code/${questId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code })
            });

            const data = await response.json();

            if (data.success) {
                showCongratulations(data.points, data.new_total_points);
            } else {
                showError(data.error || 'INVALID ACCESS CODE');
                submitCodeBtn.disabled = false;
                submitCodeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Verify Access';
            }
        } catch (error) {
            showError('NETWORK ERROR');
            submitCodeBtn.disabled = false;
            submitCodeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Verify Access';
        }
    }

    function showError(message) {
        errorText.textContent = message;
        errorMessage.classList.remove('hidden');
        setTimeout(() => {
            errorMessage.classList.add('hidden');
        }, 3000);
    }

    function showCongratulations(points, total) {
        pointsEarned.textContent = `+${points}`;
        totalPoints.textContent = total;
        congratsModal.classList.remove('hidden');
    }

    continueBtn.addEventListener('click', () => {
        window.location.href = '/quests/';
    });
</script>
{% endblock %}