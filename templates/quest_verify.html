{% extends "base.html" %}

{% block content %}
<div data-quest-id="{{ quest.id }}" data-video-url="{{ quest.action_url }}" data-quest-type="{{ quest.quest_type }}" data-points="{{ quest.points }}" id="questData" style="display: none;"></div>
<div class="w-full" style="min-height: calc(100vh - 6rem); padding-top: 1rem; padding-bottom: 1rem;">
    <div class="max-w-2xl w-full mx-auto">
        <!-- Quest Header Card -->
        <div
            class="bg-cyber-dark/80 backdrop-blur-md rounded-2xl border border-cyber-gold/30 shadow-neon-gold p-6 mb-4 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyber-gold to-cyber-red"></div>

            <div class="text-center relative z-10">
                <div
                    class="w-20 h-20 mx-auto bg-cyber-black rounded-full flex items-center justify-center mb-4 border border-white/10 shadow-lg">
                    {% if quest.quest_type == 'visit' %}
                    <i class="fas fa-link text-4xl text-green-400"></i>
                    {% elif quest.quest_type == 'manual' %}
                    <i class="fas fa-user-check text-4xl text-cyan-400"></i>
                    {% else %}
                    <i class="fab fa-youtube text-4xl text-red-500"></i>
                    {% endif %}
                </div>
                <h1 class="text-3xl font-bold text-white uppercase tracking-widest glitch-text mb-2"
                    data-text="{{ quest.title }}">
                    {{ quest.title }}
                </h1>
                <p class="text-gray-400 mb-4 font-mono text-sm">{{ quest.description or 'Follow the instructions below to complete this mission.' }}</p>
                <div
                    class="inline-flex items-center gap-2 bg-cyber-gold/10 border border-cyber-gold/50 rounded-lg px-4 py-2">
                    <i class="fas fa-coins text-cyber-gold"></i>
                    <span class="text-cyber-gold font-bold uppercase tracking-wider">{{ quest.points }} Credits</span>
                </div>
            </div>
        </div>

        <!-- Verification Steps Card -->
        <div class="bg-cyber-dark/80 backdrop-blur-md rounded-2xl border border-white/5 shadow-2xl p-6 relative">
            {% if quest.quest_type == 'manual' %}
            {% if existing_submission and existing_submission.submitted_at and (existing_submission.status in ['submitted', 'pending'] or existing_submission.verification_status == 'pending') and (existing_submission.status != 'rejected' and existing_submission.verification_status != 'rejected') %}
            <div class="space-y-6">
                <div class="bg-green-500/10 border border-green-500/30 text-green-200 rounded-xl p-5 flex flex-col gap-3">
                    <div class="flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-green-500/20 border border-green-500/40">
                            <i class="fas fa-hourglass-half"></i>
                        </span>
                        <div class="text-left">
                            <h2 class="text-lg font-bold uppercase tracking-wider">Proof Submitted</h2>
                            <p class="text-sm text-green-100/80">Thanks! Our team is reviewing your submission. Points will be awarded once approved.</p>
                        </div>
                    </div>
                    {% if existing_submission.submitted_at %}
                    <p class="text-xs uppercase tracking-[0.3em] text-green-100/60">Submitted {{ existing_submission.submitted_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% endif %}
                    <p class="text-xs uppercase tracking-[0.3em] text-green-100/60">Status {{ (existing_submission.verification_status or existing_submission.status or 'pending')|title }}</p>
                    {% if existing_submission.submission_link %}
                    <a href="{{ existing_submission.submission_link }}" target="_blank" rel="noopener"
                        class="inline-flex items-center gap-2 text-sm font-bold text-green-200 underline underline-offset-4">
                        <i class="fas fa-external-link-alt"></i>
                        View Submitted Link
                    </a>
                    {% endif %}
                </div>
            </div>
            {% elif existing_submission and (existing_submission.status == 'rejected' or existing_submission.verification_status == 'rejected') %}
            <div class="space-y-6">
                <div class="bg-red-500/10 border border-red-500/30 text-red-200 rounded-xl p-5 flex flex-col gap-3">
                    <div class="flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-red-500/20 border border-red-500/40">
                            <i class="fas fa-times-circle"></i>
                        </span>
                        <div class="text-left">
                            <h2 class="text-lg font-bold uppercase tracking-wider">Submission Rejected</h2>
                            <p class="text-sm text-red-100/80">Review the feedback below, acknowledge it, and you can resubmit new proof.</p>
                        </div>
                    </div>
                    <div class="bg-red-500/20 border border-red-500/40 rounded-lg p-4 text-sm text-red-100">
                        <p class="font-bold uppercase tracking-[0.3em] text-xs mb-1">Reason Provided</p>
                        <p>{{ existing_submission.admin_notes or 'Please review the quest instructions and try again.' }}</p>
                    </div>
                    <button id="manualAcknowledgeBtn"
                        class="w-full bg-cyber-gold hover:bg-yellow-400 text-cyber-black font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-neon-gold uppercase tracking-widest clip-path-polygon">
                        <i class="fas fa-check mr-2"></i>
                        Acknowledge & Retry
                    </button>
                </div>
            </div>
            {% else %}
            <div id="manualSection" class="space-y-6">
                <div class="bg-white/5 border border-white/10 rounded-xl p-5 text-left">
                    <h2 class="text-2xl font-bold text-white uppercase tracking-wider mb-2">Quest Brief</h2>
                    <p class="text-gray-300 leading-relaxed text-sm">{{ quest.description or 'Complete the mission and provide evidence for manual verification.' }}</p>
                    {% if quest.verification_instructions %}
                    <div class="mt-4 text-sm text-cyber-gold whitespace-pre-line">
                        {{ quest.verification_instructions }}
                    </div>
                    {% endif %}
                </div>

                {% if quest.action_url %}
                <a href="{{ quest.action_url }}" target="_blank" rel="noopener"
                    class="inline-flex items-center justify-center gap-2 bg-cyan-500 hover:bg-cyan-400 text-cyber-black font-bold px-6 py-3 rounded-lg uppercase tracking-widest shadow-lg hover:shadow-cyan-500/40 transition-transform transform hover:scale-105 clip-path-polygon">
                    <i class="fas fa-link"></i>
                    Open Quest Link
                </a>
                {% endif %}

                <form id="manualProofForm" class="space-y-5" autocomplete="off">
                    <div class="manual-input-wrapper">
                        <label for="manualLinkInput" class="block text-xs font-bold uppercase tracking-[0.3em] text-cyber-gold mb-2">Proof Link</label>
                        <input type="url" id="manualLinkInput" name="proof_link" placeholder="https://example.com/your-proof"
                            class="w-full bg-cyber-black/80 border border-cyan-400/40 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-cyan-300 focus:ring-2 focus:ring-cyan-500/40 transition-all shadow-[0_0_10px_rgba(56,189,248,0.25)] animate-manual-input"
                            inputmode="url" required>
                        <p class="text-xs text-gray-400 mt-2">Paste a link where we can verify your mission (public post, profile, form response, etc.).</p>
                    </div>

                    <div>
                        <label for="manualNotes" class="block text-xs font-bold uppercase tracking-[0.3em] text-cyber-gold mb-2">Additional Notes (Optional)</label>
                        <textarea id="manualNotes" name="notes" rows="3"
                            class="w-full bg-cyber-black/80 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-cyber-gold focus:ring-1 focus:ring-cyber-gold transition-all"
                            placeholder="Mention anything we should know, like the account name used."></textarea>
                    </div>

                    <button id="manualSubmitBtn" type="submit"
                        class="w-full bg-cyber-gold hover:bg-yellow-400 text-cyber-black font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-neon-gold uppercase tracking-widest clip-path-polygon">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Submit For Review
                    </button>
                </form>
            </div>
            {% endif %}
            {% else %}

            <!-- Step 1: Start Watch Button -->
            <div id="startSection" class="text-center">
                <h2 class="text-2xl font-bold text-white mb-4 uppercase tracking-wider">Mission Briefing</h2>
                <p class="text-gray-400 mb-6 font-mono text-sm">
                    {% if quest.quest_type == 'visit' %}
                    Access the target link to initiate the synchronization timer.
                    {% else %}
                    Initiate video playback to start the synchronization timer.
                    {% endif %}
                </p>
                <button id="startWatchBtn"
                    class="bg-cyber-red hover:bg-red-600 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-neon-red uppercase tracking-widest clip-path-polygon">
                    {% if quest.quest_type == 'visit' %}
                    <i class="fas fa-link mr-2"></i>
                    Visit Link
                    {% else %}
                    <i class="fab fa-youtube mr-2"></i>
                    Start Mission
                    {% endif %}
                </button>
            </div>

            <!-- Step 2: Countdown Timer -->
            <div id="countdownSection" class="hidden text-center">
                <h2 class="text-2xl font-bold text-white mb-4 uppercase tracking-wider">Syncing...</h2>
                <p class="text-gray-400 mb-6 font-mono text-sm">
                    {% if quest.quest_type == 'visit' %}
                    Browsing target. Reward unlocks upon completion.
                    {% else %}
                    Watch the transmission. Code input unlocks upon completion.
                    {% endif %}
                </p>

                <!-- Circular Progress Timer -->
                <div class="relative w-64 h-64 mx-auto mb-6">
                    <svg class="transform -rotate-90 w-64 h-64">
                        <circle cx="128" cy="128" r="120" stroke="rgba(255,255,255,0.05)" stroke-width="4"
                            fill="none" />
                        <circle id="progressCircle" cx="128" cy="128" r="120" stroke="#FEBD11" stroke-width="4"
                            fill="none" stroke-dasharray="753.98" stroke-dashoffset="0"
                            class="transition-all duration-1000 shadow-[0_0_10px_#FEBD11]" stroke-linecap="round" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="timerDisplay" class="text-6xl font-bold text-white mb-2 font-mono">02:00</span>
                        <span class="text-cyber-gold text-xs uppercase tracking-widest animate-pulse">Remaining</span>
                    </div>
                </div>

                <div class="bg-cyber-black/50 border border-cyber-gold/20 rounded-lg p-4">
                    <p class="text-cyber-gold text-xs font-mono uppercase">
                        <i class="fas fa-lock mr-2"></i>
                        Security Protocol Active
                    </p>
                </div>
            </div>

            <!-- Step 3: Code Input / Claim -->
            <div id="codeSection" class="hidden text-center">
                {% if quest.quest_type == 'visit' %}
                <h2 class="text-2xl font-bold text-white mb-4 uppercase tracking-wider">Mission Accomplished</h2>
                <p class="text-gray-400 mb-6 font-mono text-sm">Target verified. Claim your reward.</p>

                <div class="max-w-md mx-auto">
                    <button id="claimRewardBtn"
                        class="w-full bg-cyber-gold hover:bg-yellow-400 text-cyber-black font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-neon-gold uppercase tracking-widest clip-path-polygon">
                        <i class="fas fa-gift mr-2"></i>
                        Claim Prize
                    </button>
                </div>
                {% else %}
                <h2 class="text-2xl font-bold text-white mb-4 uppercase tracking-wider">Verification Required</h2>
                <p class="text-gray-400 mb-6 font-mono text-sm">Enter the access code from the transmission.</p>

                <div class="max-w-md mx-auto">
                    <input type="text" id="codeInput" placeholder="ENTER CODE"
                        class="w-full bg-cyber-black border border-cyber-gold/50 rounded-lg px-6 py-4 text-cyber-gold text-center text-2xl font-bold placeholder-gray-700 focus:outline-none focus:border-cyber-gold focus:shadow-neon-gold transition-all mb-4 uppercase tracking-widest font-mono"
                        maxlength="20">

                    <div id="errorMessage" class="hidden bg-red-500/10 border border-red-500/50 rounded-lg p-3 mb-4">
                        <p class="text-red-400 text-xs font-mono uppercase">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <span id="errorText"></span>
                        </p>
                    </div>

                    <button id="submitCodeBtn"
                        class="w-full bg-cyber-gold hover:bg-yellow-400 text-cyber-black font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-neon-gold uppercase tracking-widest clip-path-polygon">
                        <i class="fas fa-check mr-2"></i>
                        Verify Access
                    </button>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Back Button -->
        <div class="text-center mt-4">
            <a href="{{ url_for('quests.list_quests') }}"
                class="text-gray-500 hover:text-cyber-gold transition-colors text-sm uppercase tracking-wider">
                <i class="fas fa-arrow-left mr-2"></i>
                Abort Mission
            </a>
        </div>
    </div>
</div>

<!-- Congratulations Modal -->
<div id="congratsModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="congrats-title" role="dialog"
    aria-modal="true">
    <div class="fixed inset-0 bg-cyber-black/90 backdrop-blur-md transition-opacity"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                class="relative transform overflow-hidden rounded-2xl bg-cyber-dark border border-cyber-gold text-center shadow-2xl shadow-cyber-gold/20 transition-all w-full max-w-md p-8">
                <!-- Confetti Animation -->
                <div class="confetti-container absolute inset-0 pointer-events-none overflow-hidden opacity-50">
                    <div class="confetti bg-cyber-gold"></div>
                    <div class="confetti bg-cyber-red"></div>
                    <div class="confetti bg-white"></div>
                </div>

                <!-- Success Icon -->
                <div
                    class="w-24 h-24 mx-auto bg-cyber-black border-2 border-cyber-gold rounded-full flex items-center justify-center mb-6 shadow-neon-gold animate-bounce">
                    <i class="fas fa-trophy text-5xl text-cyber-gold"></i>
                </div>

                <h2 id="congrats-title" class="text-3xl font-bold text-white mb-2 uppercase tracking-widest glitch-text"
                    data-text="Mission Complete">
                    Mission Complete
                </h2>

                <p class="text-gray-400 mb-6 font-mono text-sm">Reward transferred to your account.</p>

                <div class="bg-cyber-gold/10 border border-cyber-gold/30 rounded-lg p-6 mb-6">
                    <p class="text-cyber-gold text-xs uppercase tracking-wider mb-2">Credits Acquired</p>
                    <p id="pointsEarned" class="text-5xl font-bold text-white text-shadow-gold">+0</p>
                </div>

                <div class="bg-white/5 rounded-lg p-4 mb-6 flex justify-between items-center">
                    <p class="text-gray-400 text-xs uppercase tracking-wider">Total Balance</p>
                    <p id="totalPoints" class="text-xl font-bold text-cyber-gold">0</p>
                </div>

                <button id="continueBtn"
                    class="w-full bg-cyber-gold hover:bg-yellow-400 text-cyber-black font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-neon-gold uppercase tracking-widest clip-path-polygon">
                    <i class="fas fa-forward mr-2"></i>
                    Continue
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .clip-path-polygon {
        clip-path: polygon(5% 0, 100% 0, 100% 80%, 95% 100%, 0 100%, 0 20%);
    }

    .text-shadow-gold {
        text-shadow: 0 0 10px rgba(254, 189, 17, 0.5);
    }

    .manual-input-wrapper {
        position: relative;
    }

    .manual-input-wrapper::before {
        content: '';
        position: absolute;
        inset: -2px;
        border-radius: 14px;
        background: linear-gradient(120deg, rgba(56, 189, 248, 0.25), rgba(254, 189, 17, 0.2), rgba(56, 189, 248, 0.25));
        z-index: -1;
        animation: borderGlow 6s linear infinite;
        opacity: 0.8;
    }

    .manual-input-wrapper:focus-within::before {
        opacity: 1;
    }

    @keyframes borderGlow {
        0% {
            transform: rotate(0deg);
        }
        50% {
            transform: rotate(180deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    @media (prefers-reduced-motion: reduce) {
        .animate-manual-input {
            animation: none !important;
        }
        .manual-input-wrapper::before {
            animation: none !important;
        }
    }

    /* Confetti Animation */
    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #FEBD11;
        animation: confetti-fall 3s linear infinite;
    }

    .confetti:nth-child(1) {
        left: 10%;
        animation-delay: 0s;
        background: #FEBD11;
    }

    .confetti:nth-child(2) {
        left: 20%;
        animation-delay: 0.2s;
        background: #f31e21;
    }

    .confetti:nth-child(3) {
        left: 30%;
        animation-delay: 0.4s;
        background: #ffffff;
    }

    .confetti:nth-child(4) {
        left: 40%;
        animation-delay: 0.6s;
        background: #FEBD11;
    }

    .confetti:nth-child(5) {
        left: 50%;
        animation-delay: 0.8s;
        background: #f31e21;
    }

    .confetti:nth-child(6) {
        left: 60%;
        animation-delay: 1s;
        background: #ffffff;
    }

    .confetti:nth-child(7) {
        left: 70%;
        animation-delay: 1.2s;
        background: #FEBD11;
    }

    .confetti:nth-child(8) {
        left: 80%;
        animation-delay: 1.4s;
        background: #f31e21;
    }

    .confetti:nth-child(9) {
        left: 90%;
        animation-delay: 1.6s;
        background: #ffffff;
    }

    @keyframes confetti-fall {
        0% {
            top: -10%;
            transform: translateX(0) rotateZ(0deg);
        }

        100% {
            top: 110%;
            transform: translateX(100px) rotateZ(360deg);
        }
    }
</style>

<script>
    const questData = document.getElementById('questData');
    const questId = parseInt(questData.dataset.questId);
    const videoUrl = questData.dataset.videoUrl;
    const questType = questData.dataset.questType;
    const totalSeconds = questType === 'visit' ? 60 : 120; // 1 min for visit, 2 min for youtube
    let timeLeft = totalSeconds;
    let timerInterval = null;

    const startSection = document.getElementById('startSection');
    const countdownSection = document.getElementById('countdownSection');
    const codeSection = document.getElementById('codeSection');
    const startWatchBtn = document.getElementById('startWatchBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const progressCircle = document.getElementById('progressCircle');
    const codeInput = document.getElementById('codeInput');
    const submitCodeBtn = document.getElementById('submitCodeBtn');
    const claimRewardBtn = document.getElementById('claimRewardBtn');
    const questPoints = parseInt(questData.dataset.points || '0');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const congratsModal = document.getElementById('congratsModal');
    const pointsEarned = document.getElementById('pointsEarned');
    const totalPoints = document.getElementById('totalPoints');
    const continueBtn = document.getElementById('continueBtn');

    const manualForm = document.getElementById('manualProofForm');
    const manualSubmitBtn = document.getElementById('manualSubmitBtn');
    const manualLinkInput = document.getElementById('manualLinkInput');
    const manualNotesInput = document.getElementById('manualNotes');
    const manualAcknowledgeBtn = document.getElementById('manualAcknowledgeBtn');

    const circumference = 2 * Math.PI * 120; // 2Ï€r

    // Load canvas-confetti
    const script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js";
    document.head.appendChild(script);

    if (startWatchBtn) {
        startWatchBtn.addEventListener('click', () => {
            if (videoUrl) {
                window.open(videoUrl, '_blank');
            }
            if (startSection) startSection.classList.add('hidden');
            if (countdownSection) countdownSection.classList.remove('hidden');
            startCountdown();
        });
    }

    if (submitCodeBtn) {
        submitCodeBtn.addEventListener('click', submitCode);
    }

    if (codeInput) {
        codeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitCode();
            }
        });
    }

    if (claimRewardBtn) {
        claimRewardBtn.addEventListener('click', claimReward);
    }

    if (manualForm) {
        manualForm.addEventListener('submit', submitManualProof);
    }

    if (manualAcknowledgeBtn) {
        manualAcknowledgeBtn.addEventListener('click', acknowledgeManualRejection);
    }

    function startCountdown() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimer();

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showCodeInput();
            }
        }, 1000);
    }

    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        if (timerDisplay) {
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if (timeLeft <= 10) {
                timerDisplay.classList.add('text-cyber-red', 'animate-pulse');
            }
        }

        const progress = (timeLeft / totalSeconds) * circumference;
        if (progressCircle) {
            progressCircle.style.strokeDashoffset = circumference - progress;
        }
    }

    function showCodeInput() {
        if (countdownSection) countdownSection.classList.add('hidden');
        if (codeSection) codeSection.classList.remove('hidden');
        if (codeInput) codeInput.focus();
    }

    async function claimReward() {
        if (!claimRewardBtn) return;
        claimRewardBtn.disabled = true;
        const origHtml = claimRewardBtn.innerHTML;
        claimRewardBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>CLAIMING...';

        try {
            const response = await fetch(`/quests/complete/${questId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            let data = {};
            try {
                data = await response.json();
            } catch (e) {
                // non-json response
            }

            if (!response.ok) {
                const err = data && (data.error || data.message) ? (data.error || data.message) : `Server returned ${response.status}`;
                showError(err);
                claimRewardBtn.disabled = false;
                claimRewardBtn.innerHTML = origHtml;
                return;
            }

            const newTotal = data.new_points || data.new_total_points || null;
            showCongratulations(questPoints, newTotal);

        } catch (error) {
            showError('NETWORK ERROR');
            claimRewardBtn.disabled = false;
            claimRewardBtn.innerHTML = origHtml;
        }
    }

    async function submitCode() {
        if (!codeInput || !submitCodeBtn) return;
        const code = codeInput.value.trim();

        if (!code) {
            showError('ACCESS CODE REQUIRED');
            return;
        }

        submitCodeBtn.disabled = true;
        submitCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>VERIFYING...';

        try {
            const response = await fetch(`/quests/verify-code/${questId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code })
            });

            const data = await response.json();

            if (data.success) {
                showCongratulations(data.points ?? questPoints, data.new_total_points ?? data.new_points);
            } else {
                showError(data.error || 'INVALID ACCESS CODE');
                submitCodeBtn.disabled = false;
                submitCodeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Verify Access';
            }
        } catch (error) {
            showError('NETWORK ERROR');
            submitCodeBtn.disabled = false;
            submitCodeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Verify Access';
        }
    }

    async function submitManualProof(event) {
        event.preventDefault();
        if (!manualSubmitBtn) return;

        const originalHtml = manualSubmitBtn.innerHTML;
        const proofLink = manualLinkInput ? manualLinkInput.value.trim() : '';
        const notes = manualNotesInput ? manualNotesInput.value.trim() : '';

        if (!proofLink) {
            showError('PLEASE PROVIDE A PROOF LINK.');
            manualSubmitBtn.disabled = false;
            manualSubmitBtn.innerHTML = originalHtml;
            return;
        }

        manualSubmitBtn.disabled = true;
        manualSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>SENDING...';

        const formData = new FormData();
        formData.append('proof_link', proofLink);

        if (notes) {
            formData.append('notes', notes);
        }

        try {
            const response = await fetch(`/quests/manual-submit/${questId}`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json().catch(() => ({}));

            if (!response.ok) {
                throw new Error(data.error || `Server returned ${response.status}`);
            }

            if (typeof showModal === 'function') {
                showModal('Submission Received', data.message || 'Thanks! We will review your proof shortly.', () => {
                    window.location.reload();
                });
            } else {
                alert(data.message || 'Submission received. We will review it shortly.');
                window.location.reload();
            }

        } catch (error) {
            showError(error.message || 'Submission failed.');
            manualSubmitBtn.disabled = false;
            manualSubmitBtn.innerHTML = originalHtml;
            return;
        }
    }

    async function acknowledgeManualRejection() {
        if (!manualAcknowledgeBtn) return;
        const originalHtml = manualAcknowledgeBtn.innerHTML;
        manualAcknowledgeBtn.disabled = true;
        manualAcknowledgeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

        try {
            const response = await fetch(`/quests/manual-ack/${questId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.status === 'success') {
                if (typeof showModal === 'function') {
                    showModal('Acknowledged', data.message || 'You can resubmit new proof now.', () => {
                        window.location.reload();
                    });
                } else {
                    alert(data.message || 'You can resubmit new proof now.');
                    window.location.reload();
                }
            } else {
                throw new Error(data.error || 'Unable to acknowledge rejection.');
            }
        } catch (error) {
            showError(error.message || 'Unable to acknowledge rejection.');
            manualAcknowledgeBtn.disabled = false;
            manualAcknowledgeBtn.innerHTML = originalHtml;
        }
    }

    function showError(message) {
        if (typeof errorText !== 'undefined' && errorText) {
            errorText.textContent = message;
            if (errorMessage) errorMessage.classList.remove('hidden');
            setTimeout(() => {
                if (errorMessage) errorMessage.classList.add('hidden');
            }, 3000);
            return;
        }

        try {
            if (typeof showModal === 'function') {
                showModal('Error', message);
                return;
            }
        } catch (e) {
            // ignore
        }

        alert(message);
    }

    function showCongratulations(points, total) {
        pointsEarned.textContent = `+${points}`;
        totalPoints.textContent = total;
        congratsModal.classList.remove('hidden');

        const duration = 5 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 200, colors: ['#FEBD11', '#f31e21', '#ffffff'] };

        function randomInRange(min, max) {
            return Math.random() * (max - min) + min;
        }

        const interval = setInterval(function() {
            const timeLeft = animationEnd - Date.now();

            if (timeLeft <= 0) {
                return clearInterval(interval);
            }

            const particleCount = 50 * (timeLeft / duration);
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
        }, 250);
    }

    if (continueBtn) {
        continueBtn.addEventListener('click', () => {
            window.location.href = '/quests/';
        });
    }
</script>
{% endblock %}