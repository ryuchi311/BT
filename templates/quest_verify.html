{% extends "base.html" %}

{% block content %}
<div class="min-h-screen flex items-center justify-center px-4 py-12">
    <div class="max-w-2xl w-full">
        <!-- Quest Header Card -->
        <div
            class="bg-gradient-to-br from-[#1a1a2e] to-[#16213e] rounded-2xl border border-blue-500/30 shadow-2xl p-8 mb-6">
            <div class="text-center">
                <div
                    class="w-20 h-20 mx-auto bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center mb-4">
                    <i class="fab fa-youtube text-4xl text-white"></i>
                </div>
                <h1
                    class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
                    {{ quest.title }}
                </h1>
                <p class="text-gray-300 mb-4">{{ quest.description }}</p>
                <div
                    class="inline-flex items-center gap-2 bg-yellow-500/20 border border-yellow-500/50 rounded-lg px-4 py-2">
                    <i class="fas fa-coins text-yellow-400"></i>
                    <span class="text-yellow-300 font-bold">{{ quest.points }} Points</span>
                </div>
            </div>
        </div>

        <!-- Verification Steps Card -->
        <div class="bg-gradient-to-br from-[#1a1a2e] to-[#16213e] rounded-2xl border border-blue-500/30 shadow-2xl p-8">

            <!-- Step 1: Start Watch Button -->
            <div id="startSection" class="text-center">
                <h2 class="text-2xl font-bold text-white mb-4">Ready to Watch?</h2>
                <p class="text-gray-300 mb-6">Click the button below to open the video and start the timer</p>
                <button id="startWatchBtn"
                    class="bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-red-500/50">
                    <i class="fab fa-youtube mr-2"></i>
                    Start Watch
                </button>
            </div>

            <!-- Step 2: Countdown Timer -->
            <div id="countdownSection" class="hidden text-center">
                <h2 class="text-2xl font-bold text-white mb-4">Watch the Video</h2>
                <p class="text-gray-300 mb-6">Please watch the entire video. You can submit the code after the timer
                    ends.</p>

                <!-- Circular Progress Timer -->
                <div class="relative w-64 h-64 mx-auto mb-6">
                    <svg class="transform -rotate-90 w-64 h-64">
                        <circle cx="128" cy="128" r="120" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none" />
                        <circle id="progressCircle" cx="128" cy="128" r="120" stroke="url(#gradient)" stroke-width="8"
                            fill="none" stroke-dasharray="753.98" stroke-dashoffset="0"
                            class="transition-all duration-1000" stroke-linecap="round" />
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="timerDisplay" class="text-6xl font-bold text-white mb-2">02:00</span>
                        <span class="text-gray-400 text-sm">Remaining</span>
                    </div>
                </div>

                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                    <p class="text-blue-300 text-sm">
                        <i class="fas fa-info-circle mr-2"></i>
                        The code input will appear when the timer reaches zero
                    </p>
                </div>
            </div>

            <!-- Step 3: Code Input -->
            <div id="codeSection" class="hidden text-center">
                <h2 class="text-2xl font-bold text-white mb-4">Enter Verification Code</h2>
                <p class="text-gray-300 mb-6">Enter the code shown in the video to claim your reward</p>

                <div class="max-w-md mx-auto">
                    <input type="text" id="codeInput" placeholder="Enter code here"
                        class="w-full bg-white/10 border border-white/20 rounded-lg px-6 py-4 text-white text-center text-2xl font-bold placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 transition-all mb-4 uppercase"
                        maxlength="20">

                    <div id="errorMessage" class="hidden bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-4">
                        <p class="text-red-300 text-sm">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <span id="errorText"></span>
                        </p>
                    </div>

                    <button id="submitCodeBtn"
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-blue-500/50">
                        <i class="fas fa-check mr-2"></i>
                        Verify Code
                    </button>
                </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="text-center mt-6">
            <a href="{{ url_for('quests.list_quests') }}" class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Quests
            </a>
        </div>
    </div>
</div>

<!-- Congratulations Modal -->
<div id="congratsModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="congrats-title" role="dialog"
    aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm transition-opacity"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                class="relative transform overflow-hidden rounded-2xl bg-gradient-to-br from-[#1a1a2e] to-[#16213e] border border-green-500/50 text-center shadow-2xl transition-all w-full max-w-md p-8">
                <!-- Confetti Animation -->
                <div class="confetti-container absolute inset-0 pointer-events-none overflow-hidden">
                    <div class="confetti"></div>
                    <div class="confetti"></div>
                    <div class="confetti"></div>
                    <div class="confetti"></div>
                    <div class="confetti"></div>
                    <div class="confetti"></div>
                    <div class="confetti"></div>
                    <div class="confetti"></div>
                    <div class="confetti"></div>
                    <div class="confetti"></div>
                </div>

                <!-- Success Icon -->
                <div
                    class="w-24 h-24 mx-auto bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mb-6 animate-bounce">
                    <i class="fas fa-trophy text-5xl text-white"></i>
                </div>

                <h2 id="congrats-title"
                    class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-500 mb-4">
                    Congratulations!
                </h2>

                <p class="text-gray-300 mb-6">You've successfully completed the quest!</p>

                <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-6 mb-6">
                    <p class="text-gray-400 text-sm mb-2">Points Earned</p>
                    <p id="pointsEarned" class="text-5xl font-bold text-green-400">+0</p>
                </div>

                <div class="bg-white/5 rounded-lg p-4 mb-6">
                    <p class="text-gray-400 text-sm mb-1">Total Points</p>
                    <p id="totalPoints" class="text-2xl font-bold text-white">0</p>
                </div>

                <button id="continueBtn"
                    class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                    <i class="fas fa-arrow-right mr-2"></i>
                    Continue to Quests
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Confetti Animation */
    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #f0f;
        animation: confetti-fall 3s linear infinite;
    }

    .confetti:nth-child(1) {
        left: 10%;
        animation-delay: 0s;
        background: #ff0;
    }

    .confetti:nth-child(2) {
        left: 20%;
        animation-delay: 0.2s;
        background: #0ff;
    }

    .confetti:nth-child(3) {
        left: 30%;
        animation-delay: 0.4s;
        background: #f0f;
    }

    .confetti:nth-child(4) {
        left: 40%;
        animation-delay: 0.6s;
        background: #0f0;
    }

    .confetti:nth-child(5) {
        left: 50%;
        animation-delay: 0.8s;
        background: #f00;
    }

    .confetti:nth-child(6) {
        left: 60%;
        animation-delay: 1s;
        background: #00f;
    }

    .confetti:nth-child(7) {
        left: 70%;
        animation-delay: 1.2s;
        background: #ff0;
    }

    .confetti:nth-child(8) {
        left: 80%;
        animation-delay: 1.4s;
        background: #0ff;
    }

    .confetti:nth-child(9) {
        left: 90%;
        animation-delay: 1.6s;
        background: #f0f;
    }

    .confetti:nth-child(10) {
        left: 95%;
        animation-delay: 1.8s;
        background: #0f0;
    }

    @keyframes confetti-fall {
        0% {
            top: -10%;
            transform: translateX(0) rotateZ(0deg);
        }

        100% {
            top: 110%;
            transform: translateX(100px) rotateZ(360deg);
        }
    }

    /* Pulse animation for timer */
    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }

    .timer-pulse {
        animation: pulse 1s ease-in-out infinite;
    }
</style>

<script>
    const questId = {{ quest.id }};
    const videoUrl = "{{ quest.action_url }}";
    const totalSeconds = 120; // 2 minutes
    let timeLeft = totalSeconds;
    let timerInterval = null;

    const startSection = document.getElementById('startSection');
    const countdownSection = document.getElementById('countdownSection');
    const codeSection = document.getElementById('codeSection');
    const startWatchBtn = document.getElementById('startWatchBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const progressCircle = document.getElementById('progressCircle');
    const codeInput = document.getElementById('codeInput');
    const submitCodeBtn = document.getElementById('submitCodeBtn');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const congratsModal = document.getElementById('congratsModal');
    const pointsEarned = document.getElementById('pointsEarned');
    const totalPoints = document.getElementById('totalPoints');
    const continueBtn = document.getElementById('continueBtn');

    const circumference = 2 * Math.PI * 120; // 2Ï€r

    // Start Watch Button
    startWatchBtn.addEventListener('click', () => {
        // Open YouTube video in new tab
        window.open(videoUrl, '_blank');

        // Show countdown section
        startSection.classList.add('hidden');
        countdownSection.classList.remove('hidden');

        // Start countdown
        startCountdown();
    });

    function startCountdown() {
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimer();

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showCodeInput();
            }
        }, 1000);
    }

    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        // Update circular progress
        const progress = (timeLeft / totalSeconds) * circumference;
        progressCircle.style.strokeDashoffset = circumference - progress;

        // Change color based on time left
        if (timeLeft <= 10) {
            timerDisplay.classList.add('text-red-400', 'timer-pulse');
        } else if (timeLeft <= 30) {
            timerDisplay.classList.add('text-yellow-400');
        }
    }

    function showCodeInput() {
        countdownSection.classList.add('hidden');
        codeSection.classList.remove('hidden');
        codeInput.focus();
    }

    // Submit Code
    submitCodeBtn.addEventListener('click', submitCode);
    codeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            submitCode();
        }
    });

    async function submitCode() {
        const code = codeInput.value.trim();

        if (!code) {
            showError('Please enter a code');
            return;
        }

        // Disable button and show loading
        submitCodeBtn.disabled = true;
        submitCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verifying...';

        try {
            const response = await fetch(`/quests/verify-code/${questId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code })
            });

            const data = await response.json();

            if (data.success) {
                // Show congratulations
                showCongratulations(data.points, data.new_total_points);
            } else {
                showError(data.error || 'Invalid code');
                submitCodeBtn.disabled = false;
                submitCodeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Verify Code';
            }
        } catch (error) {
            showError('Network error. Please try again.');
            submitCodeBtn.disabled = false;
            submitCodeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Verify Code';
        }
    }

    function showError(message) {
        errorText.textContent = message;
        errorMessage.classList.remove('hidden');
        setTimeout(() => {
            errorMessage.classList.add('hidden');
        }, 3000);
    }

    function showCongratulations(points, total) {
        pointsEarned.textContent = `+${points}`;
        totalPoints.textContent = total;
        congratsModal.classList.remove('hidden');
    }

    // Continue Button
    continueBtn.addEventListener('click', () => {
        window.location.href = '/quests/';
    });
</script>
{% endblock %}