<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Quest Hub</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Rajdhani', sans-serif;
        }

        .modal {
            display: none;
        }

        .modal.active {
            display: flex;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 min-h-screen p-4 md:p-8 pb-[90px]" style="padding-bottom: 90px;">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold text-white mb-2">Quest Management</h1>
                <p class="text-gray-400">Create and manage platform quests</p>
            </div>
            <button id="addQuestBtn"
                class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-3 rounded-lg font-bold text-lg transition-all transform hover:scale-105 shadow-lg flex items-center gap-2">
                <span class="text-2xl">‚ûï</span> Add New Quest
            </button>
        </div>

        <!-- Quest Cards Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            {% for quest in quests %}
            <div data-quest-id="{{ quest.id }}" class="bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl overflow-hidden shadow-2xl hover:shadow-purple-500/20 transition-all duration-300 hover:scale-[1.02]
                {% if not quest.is_active %}opacity-60{% endif %}">
                <!-- Card Header -->
                <div class="p-4 bg-gradient-to-r relative z-20
                    {% if quest.quest_type == 'telegram' %}from-blue-600/20 to-blue-500/10 border-b border-blue-500/20
                    {% elif quest.quest_type == 'twitter' %}from-sky-600/20 to-sky-500/10 border-b border-sky-500/20
                    {% elif quest.quest_type == 'youtube' %}from-red-600/20 to-red-500/10 border-b border-red-500/20
                    {% else %}from-green-600/20 to-green-500/10 border-b border-green-500/20{% endif %}">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-3xl">
                            {% if quest.quest_type == 'telegram' %}
                                {% if quest.platform_config and quest.platform_config.get('image') %}
                                    <img src="{{ quest.platform_config.get('image') }}" alt="Telegram" class="w-8 h-8 rounded-full border" />
                                {% else %}
                                    <!-- Inline Telegram SVG fallback -->
                                    <svg class="w-8 h-8 text-blue-400" viewBox="0 0 240 240" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
                                        <circle cx="120" cy="120" r="120" fill="#2AABEE"/>
                                        <path d="M50 120l140-40-40 140-30-50-20 20-50-70z" fill="#fff" opacity="0.95"/>
                                    </svg>
                                {% endif %}
                            {% elif quest.quest_type == 'twitter' %}
                                <i class="fab fa-twitter text-sky-400"></i>
                            {% elif quest.quest_type == 'youtube' %}
                                <i class="fab fa-youtube text-red-500"></i>
                            {% elif quest.quest_type == 'daily_checkin' %}
                                <i class="fas fa-calendar-check text-orange-400"></i>
                            {% elif quest.quest_type == 'manual' %}
                                <i class="fas fa-hand-paper text-purple-400"></i>
                            {% elif quest.quest_type == 'visit' %}
                                {% if quest.platform_config and quest.platform_config.get('image') %}
                                    <img src="{{ quest.platform_config.get('image') }}" alt="Site" class="w-8 h-8 rounded-full border" />
                                {% else %}
                                    <i class="fas fa-link text-green-400"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-link text-green-400"></i>
                            {% endif %}
                        </span>
                        <div class="flex gap-2">
                            <span class="px-3 py-1 rounded-full text-xs font-bold
                                {% if quest.quest_type == 'telegram' %}bg-blue-500/30 text-blue-200
                                {% elif quest.quest_type == 'twitter' %}bg-sky-500/30 text-sky-200
                                {% elif quest.quest_type == 'youtube' %}bg-red-500/30 text-red-200
                                {% else %}bg-green-500/30 text-green-200{% endif %}">
                                {{ quest.quest_type.upper() }}
                            </span>
                            {% if quest.quest_type == 'telegram' and quest.platform_config and quest.platform_config.get('platform_type') %}
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-gray-700/30 text-white">
                                {{ quest.platform_config.get('platform_type')|upper }}
                            </span>
                            {% endif %}
                            {% if quest.quest_type == 'telegram' and quest.platform_config %}
                                {% if quest.platform_config.get('telegram_bot_verify', True) %}
                                <span class="px-3 py-1 rounded-full text-xs font-bold bg-blue-500/20 text-blue-100">BOT VERIFIED</span>
                                {% else %}
                                <span class="px-3 py-1 rounded-full text-xs font-bold bg-red-500/20 text-red-100">MANUAL PASS</span>
                                {% endif %}
                            {% endif %}
                            {% if quest.category %}
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-purple-500/30 text-purple-200">
                                {{ quest.category }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Card Body -->
                <div class="p-4 space-y-3 pt-6">
                    {% if quest.platform_config and quest.platform_config.get('image') %}
                    <div class="flex items-start gap-3">
                        <div class="relative">
                            <img src="{{ quest.platform_config.get('image') }}" alt="Preview" class="w-16 h-16 rounded-lg object-cover border" />
                            {% if quest.platform_config and quest.platform_config.get('chat_id') %}
                            <div class="text-xs text-gray-300 mt-2">Chat: {{ quest.platform_config.get('chat_id') }}</div>
                            {% elif quest.verification_data %}
                            <div class="text-xs text-gray-300 mt-2">Chat: {{ quest.verification_data }}</div>
                            {% endif %}
                            {% if quest.platform_config and quest.platform_config.get('image_valid') is not none and not quest.platform_config.get('image_valid') %}
                            <span title="Image appears invalid" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs px-2 rounded-full">!</span>
                            {% endif %}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">{{ quest.title }}</h3>
                        </div>
                    </div>
                    {% else %}
                    <h3 class="text-xl font-bold text-white">{{ quest.title }}</h3>
                    {% endif %}
                    <div class="quest-description-container">
                        <p class="text-sm text-gray-300 quest-description" data-quest-id="{{ quest.id }}">
                            {{ quest.description or 'No description' }}
                        </p>
                        {% if quest.description and quest.description|length > 100 %}
                        <button class="text-blue-400 hover:text-blue-300 text-xs mt-1 toggle-description-btn" 
                            data-quest-id="{{ quest.id }}">
                            See more...
                        </button>
                        {% endif %}
                    </div>

                    <div class="space-y-2 text-sm">
                        {% if quest.action_url %}
                        <div class="flex items-start gap-2">
                            <span class="text-gray-400 w-16 flex-shrink-0">üîó Link:</span>
                            <a href="{{ quest.action_url }}" target="_blank"
                                class="text-blue-400 hover:text-blue-300 truncate flex-1">
                                {{ quest.action_url }}
                            </a>
                        </div>
                        {% endif %}
                        {% if quest.verification_data %}
                        <div class="flex items-start gap-2">
                            <span class="text-gray-400 w-16 flex-shrink-0">‚úì Verify:</span>
                            <span class="text-gray-200 truncate flex-1">{{ quest.verification_data }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="flex items-center justify-between pt-3 border-t border-white/10">
                        <div class="flex items-center gap-3">
                            <span class="text-yellow-400 font-bold text-lg">üí∞ {{ quest.points }}</span>
                            {% if quest.starts_at and quest.expires_at %}
                            <span class="text-xs text-gray-400">‚è∞ {{ quest.starts_at.strftime('%Y-%m-%d') }} ‚Üí {{ quest.expires_at.strftime('%Y-%m-%d') }}</span>
                            {% elif quest.starts_at %}
                            <span class="text-xs text-gray-400">‚è≥ Starts {{ quest.starts_at.strftime('%Y-%m-%d') }}</span>
                            {% elif quest.expires_at %}
                            <span class="text-xs text-gray-400">‚è∞ Expires {{ quest.expires_at.strftime('%Y-%m-%d') }}</span>
                            {% endif %}
                        </div>
                        {% if not quest.is_active %}
                        <span class="text-xs text-red-400 font-semibold">INACTIVE</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Card Actions -->
                <div class="p-4 bg-white/5 border-t border-white/10 flex gap-2">
                    <a href="{{ url_for('quests.verify_quest', quest_id=quest.id) }}" target="_blank" rel="noopener"
                        class="preview-quest-btn flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg font-semibold text-sm transition-colors">
                        üëÅÔ∏è Preview
                    </a>

                    <button
                        class="edit-quest-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-semibold text-sm transition-colors"
                        data-quest-id="{{ quest.id }}">
                        ‚úèÔ∏è Edit
                    </button>
                    <button
                        class="toggle-quest-btn flex-1 {% if quest.is_active %}bg-yellow-600 hover:bg-yellow-700{% else %}bg-green-600 hover:bg-green-700{% endif %} text-white px-3 py-2 rounded-lg font-semibold text-sm transition-colors"
                        data-quest-id="{{ quest.id }}" data-is-active="{{ 'true' if quest.is_active else 'false' }}">
                        {% if quest.is_active %}‚ö° Disable{% else %}‚úì Enable{% endif %}
                    </button>
                    <button
                        class="delete-quest-btn bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-semibold text-sm transition-colors"
                        data-quest-id="{{ quest.id }}">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
            {% endfor %}

            {% if not quests %}
            <div class="col-span-full text-center py-16">
                <p class="text-gray-400 text-xl mb-4">No quests yet</p>
                <p class="text-gray-500">Click "Add New Quest" to create your first quest</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Add/Edit Quest Modal -->
    <div id="questModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black/70 backdrop-blur-sm">
        <div
            class="bg-gradient-to-br from-gray-900 to-gray-800 border border-white/20 rounded-2xl p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold text-white">Add New Quest</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
            </div>

            <form id="questForm" method="POST" enctype="multipart/form-data" class="space-y-4">
                <input type="hidden" id="questId" name="quest_id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Title *</label>
                        <input type="text" name="title" id="questTitle" required
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="Quest title">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Description *</label>
                        <textarea name="description" id="questDescription" rows="2" required
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="Quest description"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Platform *</label>
                        <select name="platform" id="questPlatform" required
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                            style="color: white;">
                            <option value="" style="background-color: #1f2937; color: #9ca3af;">Select...</option>
                            <option value="telegram" style="background-color: #1f2937; color: white;">‚úàÔ∏è Telegram</option>
                            <option value="twitter" style="background-color: #1f2937; color: white;">üê¶ Twitter</option>
                            <option value="youtube" style="background-color: #1f2937; color: white;">‚ñ∂Ô∏è YouTube</option>
                            <option value="visit" style="background-color: #1f2937; color: white;">üîó Website</option>
                            <option value="daily_checkin" style="background-color: #1f2937; color: white;">üìÖ Daily Check-In</option>
                            <option value="manual" style="background-color: #1f2937; color: white;">‚úã Manual</option>
                        </select>
                    </div>

                    <div id="telegramTypeField" style="display:none;">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Telegram Type</label>
                        <select name="platform_type" id="platformType" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white" style="color: white; background-color: #1f2937;">
                            <option value="channel" style="background-color: #1f2937; color: white;">Channel</option>
                            <option value="group" style="background-color: #1f2937; color: white;">Group</option>
                        </select>
                    </div>

                    <div id="telegramBotVerifyField" class="md:col-span-2 hidden">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Telegram Verification</label>
                        <input type="hidden" name="telegram_bot_verify" value="0">
                        <label class="flex items-start gap-3 p-4 rounded-xl border border-white/10 bg-white/5 cursor-pointer">
                            <input type="checkbox" name="telegram_bot_verify" id="telegramBotVerify" value="1" class="mt-1 h-5 w-5 text-blue-400 focus:ring-blue-500" checked>
                            <span class="text-sm text-gray-200 leading-relaxed">
                                Require the Telegram bot to confirm membership & username match.<br>
                                <span class="text-xs text-gray-400">Uncheck to allow manual approval without Telegram checks.</span>
                            </span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Category *</label>
                        <select name="category" id="questCategory" required
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                            style="color: white;">
                            <option value="" style="background-color: #1f2937; color: #9ca3af;">Select...</option>
                            <option value="Social" style="background-color: #1f2937; color: white;">üì± Social</option>
                            <option value="Engagement" style="background-color: #1f2937; color: white;">üí¨ Engagement</option>
                            <option value="Educational" style="background-color: #1f2937; color: white;">üìö Educational</option>
                            <option value="Reward" style="background-color: #1f2937; color: white;">üéÅ Reward</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Points *</label>
                        <input type="number" name="points" id="questPoints" min="1" required
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="50">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Start (Optional)</label>
                        <input type="datetime-local" name="starts_at" id="questStarts"
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Expiration (Optional)</label>
                        <input type="datetime-local" name="expires_at" id="questExpires"
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Link/URL *</label>
                        <div class="flex gap-2">
                            <input type="url" name="action_url" id="questUrl" required
                                class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="https://">
                        </div>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Verification Data
                            (Optional)</label>
                        <div class="flex gap-2">
                            <input type="text" name="verification_data" id="questVerification"
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="Channel ID, Tweet ID, etc.">
                            <button type="button" id="fetchTelegramImageBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm" style="display:none;">Fetch Image</button>
                        </div>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Quest Image (optional)</label>
                        <div class="flex gap-2 items-center">
                            <input type="url" name="image_url" id="questImageUrl" placeholder="https://example.com/image.jpg"
                                class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <!-- Fetch Logo button removed: validation runs automatically on image URL change -->
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Provide a direct image URL (no uploading). The URL will be used directly.</p>
                        <div id="imagePreviewContainer" class="mt-3" style="display:none;">
                            <div class="relative inline-block">
                                <img id="imagePreview" src="" class="w-24 h-24 rounded-full border" alt="Preview">
                                <span id="imageValidBadge" class="hidden absolute -bottom-2 right-0 px-2 py-1 rounded text-xs"></span>
                            </div>
                        </div>
                    </div>

                    <div id="verificationCodeField" class="md:col-span-2 hidden">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Verification Code
                            (YouTube only - optional)</label>
                        <input type="text" name="verification_code" id="questVerificationCode"
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="E.g. QUEST2024 - code users will enter to verify">
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="submit"
                        class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-3 rounded-lg font-bold transition-all">
                        Save Quest
                    </button>
                    <button type="button" id="cancelModalBtn"
                        class="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quest Data JSON -->
    <script type="application/json" id="questDataJson">
        {{ quests_data | tojson }}
    </script>

    <!-- URLs for JS -->
    <script type="application/json" id="urlsJson">
        {
            "add_quest": "{{ url_for('admin.add_quest') }}"
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Load data
            const questData = JSON.parse(document.getElementById('questDataJson').textContent);
            const urls = JSON.parse(document.getElementById('urlsJson').textContent);

            // Elements
            const modal = document.getElementById('questModal');
            const modalTitle = document.getElementById('modalTitle');
            const questForm = document.getElementById('questForm');
            const questIdInput = document.getElementById('questId');

            // Functions
            function openModal() {
                modal.classList.add('active');
            }

            function closeModal() {
                modal.classList.remove('active');
            }

            function openAddModal() {
                modalTitle.textContent = 'Add New Quest';
                questForm.action = urls.add_quest;
                questIdInput.value = '';
                questForm.reset();
                const botCheckbox = document.getElementById('telegramBotVerify');
                if (botCheckbox) {
                    botCheckbox.checked = true;
                }
                // Ensure verification code field visibility matches selected platform
                const platformEl = document.getElementById('questPlatform');
                if (platformEl) {
                    toggleVerificationCodeField(platformEl.value);
                    toggleTelegramTypeField(platformEl.value);
                }
                openModal();
            }

            function openEditModal(questId) {
                const quest = questData.find(q => q.id === questId);
                if (!quest) return;

                modalTitle.textContent = 'Edit Quest';
                questForm.action = `/admin/quest/edit/${questId}`;
                questIdInput.value = questId;

                document.getElementById('questTitle').value = quest.title;
                document.getElementById('questDescription').value = quest.description || '';
                document.getElementById('questPlatform').value = quest.quest_type;
                document.getElementById('questCategory').value = quest.category || '';
                document.getElementById('questPoints').value = quest.points;
                document.getElementById('questUrl').value = quest.action_url || '';
                document.getElementById('questVerification').value = quest.verification_data || '';
                // Set platform type if available
                const platformTypeEl = document.getElementById('platformType');
                if (platformTypeEl && quest.platform_config && quest.platform_config.platform_type) {
                    platformTypeEl.value = quest.platform_config.platform_type;
                }
                const botCheckbox = document.getElementById('telegramBotVerify');
                if (botCheckbox) {
                    let useBot = true;
                    if (quest.platform_config && typeof quest.platform_config.telegram_bot_verify !== 'undefined') {
                        const flag = quest.platform_config.telegram_bot_verify;
                        if (typeof flag === 'string') {
                            useBot = !['0', 'false', 'no', 'off'].includes(flag.toLowerCase());
                        } else {
                            useBot = Boolean(flag);
                        }
                    }
                    botCheckbox.checked = useBot;
                }
                // Populate verification_code if present
                const codeEl = document.getElementById('questVerificationCode');
                if (codeEl) codeEl.value = quest.verification_code || '';

                if (quest.expires_at) {
                    const date = new Date(quest.expires_at);
                    // Format for datetime-local: YYYY-MM-DDThh:mm
                    const dateString = new Date(date.getTime() - (date.getTimezoneOffset() * 60000))
                        .toISOString()
                        .slice(0, 16);
                    document.getElementById('questExpires').value = dateString;
                } else {
                    document.getElementById('questExpires').value = '';
                }
                if (quest.starts_at) {
                    const sDate = new Date(quest.starts_at);
                    const sDateString = new Date(sDate.getTime() - (sDate.getTimezoneOffset() * 60000))
                        .toISOString()
                        .slice(0, 16);
                    document.getElementById('questStarts').value = sDateString;
                } else {
                    document.getElementById('questStarts').value = '';
                }

                // Image preview and validation badge
                const preview = document.getElementById('imagePreview');
                const previewContainer = document.getElementById('imagePreviewContainer');
                const badge = document.getElementById('imageValidBadge');
                if (quest.platform_config && quest.platform_config.image) {
                    if (preview) { preview.src = quest.platform_config.image; }
                    if (previewContainer) { previewContainer.style.display = 'block'; }
                    if (badge) {
                        if (quest.platform_config.image_valid === false) {
                            badge.className = 'absolute -bottom-2 right-0 px-2 py-1 rounded text-xs bg-red-600 text-white';
                            badge.textContent = 'Invalid';
                            badge.classList.remove('hidden');
                        } else if (quest.platform_config.image_valid === true) {
                            badge.className = 'absolute -bottom-2 right-0 px-2 py-1 rounded text-xs bg-green-600 text-white';
                            badge.textContent = 'OK';
                            badge.classList.remove('hidden');
                        } else {
                            badge.className = 'hidden';
                        }
                    }
                } else {
                    if (preview) { preview.src = ''; }
                    if (previewContainer) { previewContainer.style.display = 'none'; }
                    if (badge) { badge.className = 'hidden'; }
                }

                // Toggle verification code field depending on platform
                toggleVerificationCodeField(quest.quest_type);
                toggleTelegramTypeField(quest.quest_type);
                // Show fetch buttons for edits (we have a quest id)
                const fetchBtn = document.getElementById('fetchTelegramImageBtn');
                if (fetchBtn) fetchBtn.style.display = quest.quest_type === 'telegram' ? 'inline-block' : 'none';
                openModal();
            }

            function toggleTelegramTypeField(selectedPlatform) {
                const wrapper = document.getElementById('telegramTypeField');
                const fetchBtn = document.getElementById('fetchTelegramImageBtn');
                const botField = document.getElementById('telegramBotVerifyField');
                if (!wrapper) return;
                if (selectedPlatform && selectedPlatform.toLowerCase() === 'telegram') {
                    wrapper.style.display = '';
                    if (botField) botField.classList.remove('hidden');
                    if (fetchBtn && document.getElementById('questId').value) fetchBtn.style.display = 'inline-block';
                } else {
                    wrapper.style.display = 'none';
                    if (botField) botField.classList.add('hidden');
                    if (fetchBtn) fetchBtn.style.display = 'none';
                }
                // Note: website fetch button removed; image URL validation runs automatically
            }

            // Show/hide the verification code input only for YouTube platform
            function toggleVerificationCodeField(selectedPlatform) {
                const wrapper = document.getElementById('verificationCodeField');
                if (!wrapper) return;
                if (selectedPlatform && selectedPlatform.toLowerCase() === 'youtube') {
                    wrapper.classList.remove('hidden');
                } else {
                    wrapper.classList.add('hidden');
                    const codeInput = document.getElementById('questVerificationCode');
                    if (codeInput) codeInput.value = '';
                }
            }

            function toggleQuest(questId, isActive) {
                const action = isActive ? 'disable' : 'enable';
                if (confirm(`Are you sure you want to ${action} this quest?`)) {
                    fetch(`/admin/quest/toggle/${questId}`, { method: 'POST' })
                        .then(response => {
                            if (response.ok) { showSuccess('Quest deleted successfully'); setTimeout(() => location.reload(), 1000); }
                            else showError('Error toggling quest');
                        })
                        .catch(err => showError('Error: ' + err));
                }
            }

            function deleteQuest(questId) {
                if (confirm('Are you sure you want to delete this quest? This cannot be undone.')) {
                    fetch(`/admin/quest/delete/${questId}`, { method: 'POST' })
                        .then(response => {
                            if (response.ok) { showSuccess('Quest deleted successfully'); setTimeout(() => location.reload(), 1000); }
                            else showError('Error deleting quest');
                        })
                        .catch(err => showError('Error: ' + err));
                }
            }

            // Event Listeners
            document.getElementById('addQuestBtn').addEventListener('click', openAddModal);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('cancelModalBtn').addEventListener('click', closeModal);

            // Toggle verification code field when platform selection changes
            const platformSelect = document.getElementById('questPlatform');
            if (platformSelect) {
                platformSelect.addEventListener('change', function (e) {
                    toggleVerificationCodeField(e.target.value);
                    toggleTelegramTypeField(e.target.value);
                });
            }

            // Fetch Logo button removed; URL input no longer controls its visibility
            const urlInput = document.getElementById('questUrl');
            if (urlInput) {
                // Keep URL input for form; no extra UI actions required here
            }

            // Handle fetch telegram image button
            const fetchImgBtn = document.getElementById('fetchTelegramImageBtn');
            if (fetchImgBtn) {
                fetchImgBtn.addEventListener('click', async function () {
                    const qid = document.getElementById('questId').value;
                    if (!qid) { showError('Please save the quest first so we can fetch the image.'); return; }
                    const chatId = document.getElementById('questVerification').value;
                    const platformType = document.getElementById('platformType') ? document.getElementById('platformType').value : 'channel';
                    showInfo('Fetching image from Telegram...');
                    try {
                        const res = await fetch(`/admin/quest/fetch_telegram_image_telethon/${qid}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ chat_id: chatId, platform_type: platformType })
                        });
                        const data = await res.json();
                        if (res.ok && data.success) {
                            showSuccess('Image fetched and saved.');
                            // show image preview in the modal
                            const preview = document.getElementById('imagePreview');
                            if (preview) {
                                preview.src = data.image_url;
                                document.getElementById('imagePreviewContainer').style.display = 'block';
                            }
                        } else {
                            showError(data.error || 'Failed to fetch image');
                        }
                    } catch (e) {
                        showError('Network error fetching image');
                    }
                });
            }

            // Fetch website button removed; logic moved to automatic validation and preview on image URL change.

            // Image preview for uploaded or URL images
            const imageFileInput = document.getElementById('questImageFile');
            const imageUrlInput = document.getElementById('questImageUrl');
            const previewImg = document.getElementById('imagePreview');
            const previewContainer = document.getElementById('imagePreviewContainer');

            // Badge element for validation status
            const badgeEl = document.getElementById('imageValidBadge');

            // Validate image URL quickly via HEAD, fallback to loading the image
            async function validateImageUrl(url, timeoutMs = 6000) {
                if (!url) return false;
                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), timeoutMs);
                    // Try HEAD first
                    const headResp = await fetch(url, { method: 'HEAD', signal: controller.signal });
                    clearTimeout(id);
                    if (headResp && headResp.ok) {
                        const ctype = headResp.headers.get('content-type') || '';
                        if (ctype.toLowerCase().startsWith('image/')) {
                            return true;
                        }
                        // Not an image according to headers
                        return false;
                    }
                } catch (e) {
                    // HEAD may fail due to CORS or server not allowing HEAD - fall back to image load
                }

                // Fallback: try to load the image into an Image object (this will respect CORS for onload/onerror)
                return new Promise((resolve) => {
                    const img = new Image();
                    let settled = false;
                    const t = setTimeout(() => {
                        if (!settled) {
                            settled = true;
                            resolve(false);
                        }
                    }, timeoutMs);
                    img.onload = function () {
                        if (!settled) {
                            settled = true;
                            clearTimeout(t);
                            resolve(true);
                        }
                    };
                    img.onerror = function () {
                        if (!settled) {
                            settled = true;
                            clearTimeout(t);
                            resolve(false);
                        }
                    };
                    img.src = url;
                });
            }

            if (imageFileInput) {
                imageFileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const url = URL.createObjectURL(file);
                    if (previewImg) {
                        previewImg.src = url;
                        previewContainer.style.display = 'block';
                        if (badgeEl) { badgeEl.className = 'hidden'; }
                    }
                });
            }

            if (imageUrlInput) {
                // Validate and preview on change
                imageUrlInput.addEventListener('change', async function (e) {
                    const url = e.target.value.trim();
                    if (!url) {
                        if (previewImg) { previewImg.src = ''; previewContainer.style.display = 'none'; }
                        if (badgeEl) { badgeEl.className = 'hidden'; }
                        return;
                    }
                    if (previewImg) {
                        previewImg.src = url;
                        previewContainer.style.display = 'block';
                    }
                    // Quick validation
                    const valid = await validateImageUrl(url);
                    if (badgeEl) {
                        if (valid) {
                            badgeEl.className = 'absolute -bottom-2 right-0 px-2 py-1 rounded text-xs bg-green-600 text-white';
                            badgeEl.textContent = 'OK';
                            badgeEl.classList.remove('hidden');
                        } else {
                            badgeEl.className = 'absolute -bottom-2 right-0 px-2 py-1 rounded text-xs bg-red-600 text-white';
                            badgeEl.textContent = 'Invalid';
                            badgeEl.classList.remove('hidden');
                        }
                    }
                    // If this is an existing (saved) quest, update the dashboard card in-place to reflect the new valid image
                    const qidVal = (document.getElementById('questId') || {}).value || null;
                    if (valid && qidVal) {
                        try {
                            const card = document.querySelector(`[data-quest-id="${qidVal}"]`);
                            if (card) {
                                // update header icon
                                const headerIcon = card.querySelector('span.text-3xl');
                                if (headerIcon) {
                                    headerIcon.innerHTML = `<img src="${url}" alt="Site" class="w-8 h-8 rounded-full border" />`;
                                }
                                // update body preview if present
                                const bodyPreview = card.querySelector('img.w-16');
                                if (bodyPreview) bodyPreview.src = url;
                                // remove any invalid badge overlay in the card body
                                const invalidBadge = card.querySelector('span[title="Image appears invalid"]');
                                if (invalidBadge) invalidBadge.remove();
                            }
                        } catch (e) {
                            // ignore DOM update errors
                        }
                    }
                });
            }

            // Also adjust badge based on actual image load outcomes to handle CORS fallbacks
            if (previewImg) {
                previewImg.addEventListener('load', function () {
                    if (badgeEl && (badgeEl.className === 'hidden' || badgeEl.textContent === '')) {
                        badgeEl.className = 'absolute -bottom-2 right-0 px-2 py-1 rounded text-xs bg-green-600 text-white';
                        badgeEl.textContent = 'OK';
                        badgeEl.classList.remove('hidden');
                    }
                });
                previewImg.addEventListener('error', function () {
                    if (badgeEl) {
                        badgeEl.className = 'absolute -bottom-2 right-0 px-2 py-1 rounded text-xs bg-red-600 text-white';
                        badgeEl.textContent = 'Invalid';
                        badgeEl.classList.remove('hidden');
                    }
                });
            }

            // Close on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });

    // Handle form submission with toast notifications
    document.getElementById('questForm').addEventListener('submit', function(e) {
        const isEdit = document.getElementById('questId').value !== '';
        const action = isEdit ? 'updated' : 'created';
        
        // Show loading toast
        showInfo(`${isEdit ? 'Updating' : 'Creating'} quest...`);
        
        // The form will submit normally, but we'll show success on next page load
        sessionStorage.setItem('questAction', action);
    });
    
    // Check for success message on page load
    window.addEventListener('DOMContentLoaded', function() {
        const action = sessionStorage.getItem('questAction');
        if (action) {
            sessionStorage.removeItem('questAction');
            showSuccess(`Quest ${action} successfully!`);
        }
    });

            // Delegate events for dynamically generated buttons
            document.addEventListener('click', function (e) {
                // Edit button
                const editBtn = e.target.closest('.edit-quest-btn');
                if (editBtn) {
                    const id = parseInt(editBtn.dataset.questId);
                    openEditModal(id);
                }

                // Toggle button
                const toggleBtn = e.target.closest('.toggle-quest-btn');
                if (toggleBtn) {
                    const id = parseInt(toggleBtn.dataset.questId);
                    const isActive = toggleBtn.dataset.isActive === 'true';
                    toggleQuest(id, isActive);
                }

                // Delete button
                const deleteBtn = e.target.closest('.delete-quest-btn');
                if (deleteBtn) {
                    const id = parseInt(deleteBtn.dataset.questId);
                    deleteQuest(id);
                }
            });
            // Bottom navigation button
            const addQuestBtnBottom = document.getElementById('addQuestBtnBottom');
            if (addQuestBtnBottom) {
                addQuestBtnBottom.addEventListener('click', openAddModal);
            }
        });
    </script>

    <!-- Quick Actions Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 bg-gradient-to-t from-gray-900 via-gray-900/95 to-transparent backdrop-blur-lg border-t border-white/10 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-center gap-3">
                <a href="{{ url_for('admin.verification_queue') }}"
                    class="flex-1 max-w-xs bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 py-3 rounded-xl font-bold text-sm md:text-base transition-all transform active:scale-95 shadow-lg flex items-center justify-center gap-2">
                    <span class="text-xl">üìã</span>
                    <span class="hidden sm:inline">Verification Queue</span>
                    <span class="sm:hidden">Queue</span>
                </a>
                <a href="{{ url_for('admin.manage_rewards') }}"
                    class="flex-1 max-w-xs bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700 text-white px-4 py-3 rounded-xl font-bold text-sm md:text-base transition-all transform active:scale-95 shadow-lg flex items-center justify-center gap-2">
                    <span class="text-xl">üéÅ</span>
                    <span class="hidden sm:inline">Rewards</span>
                    <span class="sm:hidden">Rewards</span>
                </a>
                <button id="addQuestBtnBottom"
                    class="flex-1 max-w-xs bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-4 py-3 rounded-xl font-bold text-sm md:text-base transition-all transform active:scale-95 shadow-lg flex items-center justify-center gap-2">
                    <span class="text-xl">‚ûï</span>
                    <span class="hidden sm:inline">Add New Quest</span>
                    <span class="sm:hidden">Add Quest</span>
                </button>
            </div>
        </div>
    </div>
<!-- Toast Notification Container -->
<div id="toast-container" class="fixed top-20 right-4 z-[60] space-y-3"></div>

<script>
    // Toast Notification System
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');

        // Define toast styles based on type
        const styles = {
            success: {
                bg: 'bg-green-500',
                icon: '‚úì',
                iconBg: 'bg-green-600'
            },
            error: {
                bg: 'bg-red-500',
                icon: '‚úï',
                iconBg: 'bg-red-600'
            },
            warning: {
                bg: 'bg-yellow-500',
                icon: '‚ö†',
                iconBg: 'bg-yellow-600'
            },
            info: {
                bg: 'bg-blue-500',
                icon: '‚Ñπ',
                iconBg: 'bg-blue-600'
            }
        };

        const style = styles[type] || styles.info;

        // Create toast element
        const toast = document.createElement('div');
        toast.className = `flex items-center w-full max-w-xs p-4 text-white ${style.bg} rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
        toast.innerHTML = `
            <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 ${style.iconBg} rounded-lg">
                <span class="text-lg font-bold">${style.icon}</span>
            </div>
            <div class="ml-3 text-sm font-semibold">${message}</div>
            <button type="button" class="ml-auto -mx-1.5 -my-1.5 rounded-lg p-1.5 inline-flex h-8 w-8 hover:bg-white/20 transition-colors" onclick="this.parentElement.remove()">
                <span class="sr-only">Close</span>
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        `;

        toastContainer.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 10);

        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // Global function to show success toast
    window.showSuccess = (message) => showToast(message, 'success');
    window.showError = (message) => showToast(message, 'error');
    window.showWarning = (message) => showToast(message, 'warning');
    window.showInfo = (message) => showToast(message, 'info');
</script>
</body>

</html>