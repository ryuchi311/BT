{% extends "base.html" %}

{% block content %}
<div class="mb-8 pt-4">
    <h1 class="text-3xl font-bold mb-2 text-white uppercase tracking-widest glitch-text" data-text="Mission Log">
        Mission Log
    </h1>
    <p class="text-cyber-gold text-sm tracking-wider uppercase">Available Contracts</p>
</div>

<div class="space-y-4">
    {% for quest in quests %}
    {% set submission = user_quests.get(quest.id) if user_quests else None %}
    <div class="group relative bg-cyber-dark/80 backdrop-blur-md border border-white/5 rounded-xl p-5 transition-all duration-300 hover:border-cyber-gold/50 hover:shadow-neon-gold animate-fade-in overflow-hidden"
        data-delay="{{ loop.index0 * 100 }}">

        <!-- Decorative corner accents -->
        <div
            class="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-white/10 rounded-tr-lg group-hover:border-cyber-gold transition-colors">
        </div>
        <div
            class="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-white/10 rounded-bl-lg group-hover:border-cyber-gold transition-colors">
        </div>

        <div class="flex items-center justify-between relative z-10">
            <div class="flex items-center space-x-4">
                <div
                    <div class="w-14 h-14 bg-cyber-black rounded-lg flex items-center justify-center text-2xl border border-white/10 shadow-inner group-hover:shadow-[0_0_15px_rgba(254,189,17,0.3)] transition-all">
                        {% if quest.quest_type == 'telegram' and quest.platform_config and quest.platform_config.get('image') %}
                        <img src="{{ quest.platform_config.get('image') }}" alt="logo" class="w-12 h-12 rounded-full object-cover border"/>
                        {% elif quest.quest_type == 'telegram' %}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 text-blue-400" aria-hidden="true">
                            <path d="M21.5 3.5L2.5 10.8c-.8.3-.8 1 .1 1.2l4 1.1 1.4 4.6c.2.6.9.7 1.2.2l2.1-3 4.9 3.6c.6.4 1.4-.1 1-1L21.5 3.5c-.2-.6-.9-.8-1.4-.5z" />
                        </svg>
                        {% elif quest.quest_type == 'twitter' %}
                        <i class="fab fa-twitter text-4xl text-sky-400"></i>
                        {% elif quest.quest_type == 'youtube' %}
                        <i class="fab fa-youtube text-4xl text-red-500"></i>
                        {% elif quest.quest_type == 'daily_checkin' %}
                        <i class="fas fa-calendar-check text-4xl text-cyber-orange"></i>
                        {% elif quest.quest_type == 'manual' %}
                        <i class="fas fa-hand-paper text-4xl text-purple-400"></i>
                        {% elif quest.quest_type == 'visit' %}
                        <i class="fas fa-link text-4xl text-green-400"></i>
                        {% endif %}
                    </div>
                <div>
                    <h3
                        class="font-bold text-lg tracking-wide text-white group-hover:text-cyber-gold transition-colors uppercase">
                        {{ quest.title }}</h3>
                    <div class="flex items-center mt-1 space-x-2">
                        <span class="text-cyber-gold font-bold text-lg">+{{ quest.points }}</span>
                        <span
                            class="text-[10px] text-cyber-black bg-cyber-gold px-1.5 py-0.5 rounded font-bold uppercase">XP</span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            {% if quest.quest_type == 'daily_checkin' %}
            {% set status = checkin_status.get(quest.id, {'checked_in': False, 'streak': 0}) %}
            {% if status['checked_in'] %}
            <div class="text-center">
                <div
                    class="bg-green-500/10 border border-green-500/30 text-green-400 px-4 py-2 rounded-lg font-bold text-sm uppercase tracking-wider">
                    <i class="fas fa-check mr-1"></i> Done
                </div>
                <div class="text-cyber-orange font-bold text-xs mt-1 uppercase tracking-wider">
                    Streak: {{ status['streak'] }}
                </div>
            </div>
            {% else %}
            <div class="text-center">
                <button onclick="checkIn('{{ quest.id }}')"
                    class="relative overflow-hidden bg-cyber-orange hover:bg-orange-600 text-white px-6 py-2.5 rounded-lg font-bold tracking-wider uppercase text-sm transition-all shadow-lg hover:shadow-orange-500/30 clip-path-polygon">
                    <span class="relative z-10">Check In</span>
                </button>
                {% if status['streak'] > 0 %}
                <div class="text-cyber-orange font-bold text-xs mt-1 uppercase tracking-wider">
                    Streak: {{ status['streak'] }}
                </div>
                {% endif %}
            </div>
            {% endif %}
            {% else %}
            {% set manual_status = submission.status if submission else None %}
            {% set manual_verification = submission.verification_status if submission else None %}
            {% if quest.id in completed_quest_ids or manual_status in ['approved', 'completed'] or manual_verification in ['verified'] %}
            <div class="text-center">
                <div
                    class="bg-green-500/10 border border-green-500/30 text-green-400 px-4 py-2 rounded-lg font-bold text-sm uppercase tracking-wider">
                    <i class="fas fa-check mr-1"></i> Done
                </div>
            </div>
            {% elif quest.quest_type == 'manual' and submission and (manual_status == 'rejected' or manual_verification == 'rejected') %}
            <div class="text-left max-w-xs">
                <div
                    class="bg-red-500/10 border border-red-500/40 text-red-300 px-4 py-2 rounded-lg font-bold text-sm uppercase tracking-wider text-center">
                    <i class="fas fa-exclamation-triangle mr-1"></i> Needs Fix
                </div>
                <p class="text-xs text-red-200 mt-2">Reason: {{ submission.admin_notes or 'Please review the quest instructions and resubmit.' }}</p>
                <button type="button" class="mt-3 w-full bg-cyber-gold hover:bg-yellow-400 text-cyber-black px-4 py-2 rounded-lg font-bold text-xs uppercase tracking-wider shadow-lg hover:shadow-neon-gold transition"
                    onclick="acknowledgeManual('{{ quest.id }}', this)">
                    <i class="fas fa-check mr-1"></i>Acknowledge
                </button>
            </div>
            {% elif quest.quest_type == 'manual' and submission and manual_status == 'submitted' %}
            <div class="text-center">
                <div
                    class="bg-blue-500/10 border border-blue-500/30 text-blue-300 px-4 py-2 rounded-lg font-bold text-sm uppercase tracking-wider">
                    <i class="fas fa-sync-alt mr-1"></i> In Review
                </div>
                <p class="text-xs text-gray-400 mt-2 max-w-xs">Our team is still reviewing your proof. Sit tight!</p>
            </div>
            {% else %}
            <a href="{{ url_for('quests.verify_quest', quest_id=quest.id) }}"
                class="relative overflow-hidden bg-cyber-gold hover:bg-yellow-400 text-cyber-black px-6 py-2.5 rounded-lg font-bold tracking-wider uppercase text-sm transition-all shadow-lg hover:shadow-neon-gold clip-path-polygon group-hover:scale-105 inline-block">
                <span class="relative z-10">Start</span>
                <div
                    class="absolute inset-0 bg-white/30 transform -skew-x-12 -translate-x-full group-hover:animate-shine">
                </div>
            </a>
            {% endif %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<style>
    .clip-path-polygon {
        clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
    }

    @keyframes shine {
        100% {
            transform: translateX(200%) skewX(-12deg);
        }
    }

    .group-hover\:animate-shine:hover {
        animation: shine 0.7s;
    }
</style>

<script>
    // Apply staggered animation delays
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[data-delay]').forEach(el => {
            el.style.animationDelay = el.dataset.delay + 'ms';
        });
    });

    function checkIn(questId) {
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="relative z-10">...</span>';
        btn.disabled = true;
        btn.classList.add('opacity-75', 'cursor-not-allowed');

        fetch(`/quests/checkin/${questId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showModal('Check-in Successful', `ðŸ”¥ ${data.streak} day streak!\nðŸ’° +${data.points_earned} Credits`, () => {
                        location.reload();
                    });
                } else {
                    showModal('Error', data.error || 'Check-in failed');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showModal('Error', 'An error occurred');
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            });
    }

    function acknowledgeManual(questId, buttonRef) {
        const btn = buttonRef || event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="relative z-10"><i class="fas fa-spinner fa-spin"></i></span>';
        btn.disabled = true;
        btn.classList.add('opacity-75', 'cursor-not-allowed');

        fetch(`/quests/manual-ack/${questId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => response.json())
          .then(data => {
              if (data.status === 'success') {
                  showModal('Acknowledged', data.message || 'You can now resubmit your proof.', () => {
                      location.reload();
                  });
              } else {
                  showModal('Error', data.error || 'Unable to acknowledge.');
                  btn.innerHTML = originalText;
                  btn.disabled = false;
                  btn.classList.remove('opacity-75', 'cursor-not-allowed');
              }
          }).catch(() => {
              showModal('Error', 'Network error. Please try again.');
              btn.innerHTML = originalText;
              btn.disabled = false;
              btn.classList.remove('opacity-75', 'cursor-not-allowed');
          });
    }
</script>
{% endblock %}